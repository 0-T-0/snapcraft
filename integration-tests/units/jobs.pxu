id: snapcraft/normal/no-yaml
plugin: shell
estimated_duration: 0.1
command:
    set -x
    OUTPUT=$(${SNAPCRAFT} pull)
    test $? = 1 || exit 1
    echo $OUTPUT | grep "Could not find snapcraft\.yaml\."

id: snapcraft/normal/local-source
plugin: shell
estimated_duration: 0.3
command:
    set -ex
    cp -rT $PLAINBOX_PROVIDER_DATA/local-source .
    ${SNAPCRAFT} build
    test -e stamp-all
    test "$(readlink parts/make-project/build)" = "$(pwd)"
    ${SNAPCRAFT} stage
    test -e stamp-install

id: snapcraft/normal/local-plugin
plugin: shell
estimated_duration: 0.3
command:
    set -ex
    cp -rT $PLAINBOX_PROVIDER_DATA/local-plugin .
    ${SNAPCRAFT} snap
    test -e snap/build-stamp

id: snapcraft/normal/simple-make
plugin: shell
estimated_duration: 0.3
command:
    set -ex
    cp -rT $PLAINBOX_PROVIDER_DATA/simple-make .
    ${SNAPCRAFT} snap
    test "$(./snap/bin/test)" = "Hello world"

id: snapcraft/normal/simple-cmake
plugin: shell
estimated_duration: 0.3
command:
    set -ex
    cp -rT $PLAINBOX_PROVIDER_DATA/simple-cmake .
    ${SNAPCRAFT} snap
    test "$(./snap/bin/simple-cmake)" = "It's a CMake world"

id: snapcraft/normal/conflicts
plugin: shell
estimated_duration: 0.3
command:
    set -x
    cp -rT $PLAINBOX_PROVIDER_DATA/conflicts .
    OUTPUT=$(${SNAPCRAFT} stage)
    test $? = 1 || exit 1
    echo $OUTPUT | grep "Error: parts p1 and p2 have the following files in common: bin/test" # squished output by bash

id: snapcraft/normal/dependencies
plugin: shell
estimated_duration: 0.3
command:
    set -ex
    cp -rT $PLAINBOX_PROVIDER_DATA/dependencies .
    ${SNAPCRAFT} snap
    test -x stage/bin/p3
    test -x snap/bin/p3
    test "$(${SNAPCRAFT} shell p3)" = 'p1
    p1
    p2'

id: snapcraft/normal/dependencies-circular
plugin: shell
estimated_duration: 0.3
command:
    set -x
    cp -rT $PLAINBOX_PROVIDER_DATA/dependencies .
    sed -i "s/p1:/p1:\n    after: [p3]/" snapcraft.yaml
    OUTPUT=$(${SNAPCRAFT} pull)
    test $? = 1 || exit 1
    echo $OUTPUT | grep -i "circular dependency"

id: snapcraft/normal/dependencies-fail
plugin: shell
estimated_duration: 0.3
command:
    set -x
    cp -rT $PLAINBOX_PROVIDER_DATA/dependencies .
    sed -i '/after/d' snapcraft.yaml
    ${SNAPCRAFT} snap
    test $? = 1 || exit 1

id: snapcraft/normal/bzr-head
plugin: shell
estimated_duration: 0.3
command:
    set -ex
    cp -rT $PLAINBOX_PROVIDER_DATA/bzr-head .
    bzr init .
    bzr commit -m "1" --unchanged
    bzr commit -m "2" --unchanged
    ${SNAPCRAFT} pull # test initial branch
    test "$(bzr revno -r -1 parts/bzr/src)" = "2"
    ${SNAPCRAFT} pull # test pull doesn't fail
    test "$(bzr revno -r -1 parts/bzr/src)" = "2"

id: snapcraft/normal/bzr-tag
plugin: shell
estimated_duration: 0.3
command:
    set -ex
    cp -rT $PLAINBOX_PROVIDER_DATA/bzr-tag .
    bzr init .
    bzr commit -m "1" --unchanged
    bzr commit -m "2" --unchanged
    bzr tag -r 1 initial
    ${SNAPCRAFT} pull # test initial branch
    test "$(bzr revno -r -1 parts/bzr/src)" = "1"
    ${SNAPCRAFT} pull # test pull doesn't fail
    test "$(bzr revno -r -1 parts/bzr/src)" = "1"

id: snapcraft/normal/git-head
plugin: shell
estimated_duration: 0.3
command:
    set -ex
    cp -rT $PLAINBOX_PROVIDER_DATA/git-head .
    git init .
    git commit -m "1" --allow-empty
    git commit -m "2" --allow-empty
    ${SNAPCRAFT} pull
    test "$(git -C parts/git/src log -1 --oneline | cut -d' ' -f2)" = "2"
    ${SNAPCRAFT} pull
    test "$(git -C parts/git/src log -1 --oneline | cut -d' ' -f2)" = "2"

id: snapcraft/normal/git-tag
plugin: shell
estimated_duration: 0.3
command:
    set -ex
    cp -rT $PLAINBOX_PROVIDER_DATA/git-tag .
    git init .
    git commit -m "1" --allow-empty
    git commit -m "2" --allow-empty
    git tag initial HEAD@{1}
    ${SNAPCRAFT} pull
    test "$(git -C parts/git/src log -1 --oneline | cut -d' ' -f2)" = "1"
    ${SNAPCRAFT} pull
    test "$(git -C parts/git/src log -1 --oneline | cut -d' ' -f2)" = "1"

id: snapcraft/normal/git-branch
plugin: shell
estimated_duration: 0.3
command:
    set -ex
    cp -rT $PLAINBOX_PROVIDER_DATA/git-branch .
    git init .
    git commit -m "1" --allow-empty
    git commit -m "2" --allow-empty
    git branch second HEAD@{1}
    git checkout second
    git commit -m "3" --allow-empty
    git checkout master
    ${SNAPCRAFT} pull
    test "$(git -C parts/git/src log -2 --oneline | cut -d' ' -f2 | tr '\n' ' ')" = "3 1 "
    ${SNAPCRAFT} pull
    test "$(git -C parts/git/src log -2 --oneline | cut -d' ' -f2 | tr '\n' ' ')" = "3 1 "

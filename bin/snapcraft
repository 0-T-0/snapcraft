#!/usr/bin/python3
# -*- Mode:Python; indent-tabs-mode:t; tab-width:4 -*-

import importlib.machinery
import os
import sys
import yaml

sys.path.append(os.path.abspath(os.path.join(__file__, "..", "..")))
import snapcraft
import snapcraft.plugin

cmds = sys.argv[1:]
if cmds == ["all"]:
	cmds = ["init", "pull", "build", "test", "stage", "deploy"]

data = yaml.load(open("craft.yaml", 'r'))
pluginDir = os.path.abspath(os.path.join(__file__, "..", "..", "plugins"))

for partName in data["parts"]:
	properties = data["parts"][partName]

	pluginName = properties.get("plugin", partName)
	if "plugin" in properties: del properties["plugin"]

	plugin = snapcraft.plugin.Plugin(pluginDir, pluginName, properties)
	if not plugin.isValid():
		print("Could not load plugin %s" % pluginName, file=sys.stderr)
		sys.exit(1)

	for cmd in cmds:
		getattr(plugin, cmd)()

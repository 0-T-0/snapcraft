#!/usr/bin/python3
# -*- Mode:Python; indent-tabs-mode:t; tab-width:4 -*-

import os
import subprocess
import sys
import yaml

sys.path.append(os.path.abspath(os.path.join(__file__, "..", "..")))
import snapcraft
import snapcraft.plugin

cmds = sys.argv[1:]
if cmds == ["all"]:
	cmds = ["init", "pull", "build", "test", "stage", "deploy"]

data = yaml.load(open("craft.yaml", 'r'))
pluginDir = os.path.abspath(os.path.join(__file__, "..", "..", "plugins"))

packagesToInstall = []

for partName in data["parts"]:
	properties = data["parts"][partName]

	pluginName = properties.get("plugin", partName)
	if "plugin" in properties: del properties["plugin"]

	plugin = snapcraft.plugin.Plugin(pluginDir, pluginName, properties)
	if not plugin.isValid():
		print("Could not load plugin %s" % pluginName, file=sys.stderr)
		sys.exit(1)

	if plugin.config:
		packagesToInstall += plugin.config.get('packages', [])

# FIXME: don't do this step if we don't need to (to avoid sudo prompt)
if packagesToInstall:
	subprocess.call(['sudo', 'apt-get', 'install'] + packagesToInstall, stdout=subprocess.DEVNULL)

for partName in data["parts"]:
	for cmd in cmds:
		getattr(plugin, cmd)()
